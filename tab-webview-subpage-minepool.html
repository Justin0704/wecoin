<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>矿池</title>
    <script src="js/mui.min.js"></script>
    <script type="text/javascript" src="js/header.js" ></script>
    <script type="text/javascript" src="js/appToken.js" ></script>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <style type="text/css">
    	/*.mui-content{margin: 12px;}*/
    	.mui-btn{width: 95%;}
    	.mui-bar{background-color: #108EE9;height: 65px;}
    	.mui-row{background-color: #108EE9;}
		.mui-title{color: #FFFFFF;line-height: 75px;}
		.mui-table-view.mui-grid-9{
		    background-color: #108EE9;
		}
		.mui-grid-view.mui-grid-9 .mui-table-view-cell{
			border-right: 1px solid #108EE9;
    		border-bottom: 1px solid #108EE9;
		}
		.mui-grid-view.mui-grid-9{
			border-top: 5px solid #108EE9;
    		border-left: 1px solid #108EE9;
		}
		.mui-grid-view.mui-grid-9 .mui-media{
			color: #FFFFFF;
		}
		.mui-bar-nav {
			box-shadow: 0 1px 6px #108EE9;
		}
		.mui-bar-nav~.mui-content .mui-pull-top-pocket {
		    top: 54px;
		}
    </style>
</head>
<body>

	<header class="mui-bar mui-bar-nav">
		<h1 id="title" class="mui-title">矿池</h1>
	</header>	
	<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
		<div class="mui-scroll">
			<div class="mui-row"  style="background-color: #108EE9;">
				<ul class="mui-table-view mui-grid-view mui-grid-9">
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-6">
						<div class="mui-media-body" style="color:#FFFFFF">矿池算力(T)</div>
						<div class="mui-media-body" style="color:#FFFFFF">(截至昨天)</div>
						<h1 id="subTotalCalculates">0</h1>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-sm-3 mui-col-xs-6">
						<div class="mui-media-body" style="color:#FFFFFF">总矿工数</div>
						<div class="mui-media-body" style="color:#FFFFFF">(截至昨天)</div>
						<h1 id="totalOperationDays">0</h1>
					</li>
				</ul>
			</div>
			<div id="mymachine" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
				<a class="mui-control-item mui-active" href="#item1">直推</a>
				<a class="mui-control-item" href="#item2">团队</a>
			</div>
			
			<div id="item1" class="mui-control-content mui-active">
			</div>
			<div id="item2" class="mui-control-content">
				<!--<ul class="mui-table-view">
					<li class="mui-table-view-cell mui-media">
						<a href="#">
							<img class="mui-media-object mui-pull-left" src="http://dcloudio.github.io/mui/assets/img/yuantiao.jpg">
							<div class="mui-media-body">
								<p class='mui-ellipsis'>ID：8017838&nbsp;&nbsp;算力：0&nbsp;&nbsp;矿机：0台</p>
								<p class='mui-ellipsis'>普通矿工&nbsp;&nbsp;直推：0人&nbsp;&nbsp;团队：0人</p>
							</div>
						</a>
					</li>
				</ul>-->
			</div>
		</div>
	</div>
	<div id="popover" class="mui-popover">
	<script type="text/javascript" charset="utf-8">
      	mui.init({
      		pullRefresh: {
				container: '#pullrefresh',
				down: {
					height:50,//可选,默认50.触发下拉刷新拖动距离,
			        auto: false,//可选,默认false.首次加载自动下拉刷新一次
			        contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
			        contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
			        contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					callback: pulldownRefresh
				}/*,
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}*/
			}
      	});
      	mui.plusReady(function(){
      		//mui.toast("加载矿池页面");
      		querySubUsers();
      		queryTeamUsers();
      	});
      	
      	/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				querySubUsers();
      			queryTeamUsers();
      			mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 500);
		}
      	
      	function queryTeamUsers(){
      		mui.ajax(url + '/teamUsers',{
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				headers:{'Content-Type':'application/json'},
				crossDomain:true,
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					console.log("------------->data = " + data);
					console.log("------------->data.resultCode = " + data.resultCode);
					console.log("------------->data.resultMsg = " + data.resultMsg);
					console.log("------------->data.appToken = " + data.appToken);
					console.log("------------->data.teamUserList = " + data.teamUserList);
					//判断本地存储的appToken是否和服务器的appToken相同
					checkAppToken(data.appToken);
					if(data.resultCode == '1001'){
						//plus.ui.toast("查询矿机列表成功");
						//把appToken保存到本地
						//plus.storage.setItem('appToken',data.appToken);
						//查询成功，把列表显示到页面
						var html = "<ul class='mui-table-view' id='ul_machine'>";
						for(var i in data.teamUserList){
							html += "<li class='mui-table-view-cell mui-media'>";
							html += "<a href='javascript:;>";
							html += "<img class='mui-media-object mui-pull-left src='http://dcloudio.github.io/mui/assets/img/yuantiao.jpg'>";
							html += "<div class='mui-media-body'>";
							html += "<p class='mui-ellipsis'>ID："+data.teamUserList[i].userNo+"&nbsp;&nbsp;|&nbsp;&nbsp;算力："+data.teamUserList[i].calculate+"&nbsp;&nbsp;|&nbsp;&nbsp;矿机："+data.teamUserList[i].amount+"台</p>";
							html += "<p class='mui-ellipsis'>"+data.teamUserList[i].levelStr+"&nbsp;&nbsp;|&nbsp;&nbsp;直推："+data.teamUserList[i].subUserCount+"人&nbsp;&nbsp;|&nbsp;&nbsp;团队："+data.teamUserList[i].teamCount+"人</p>";
							html += "</div>";
							html += "</a>";
							html += "</li>";
						}
						html += "</ul>";
						document.getElementById("item2").innerHTML = html;
						//统计下线总矿池算力
						var subTotalCalculates = data.subTotalCalculates;
						document.getElementById("subTotalCalculates").innerText = subTotalCalculates;
						var totalOperationDays = data.totalOperationDays;
						document.getElementById("totalOperationDays").innerText = totalOperationDays;
					}else if(data.resultCode = '5008'){
						mui.toast(data.resultMsg);
					}
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					mui.toast("系统异常！");
					console.log("异常: " + type);
				}
			});      		
      	}
      	function querySubUsers(){
      		mui.ajax(url + '/subUsers',{
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				headers:{'Content-Type':'application/json'},
				crossDomain:true,
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					console.log("------------->data = " + data);
					console.log("------------->data.resultCode = " + data.resultCode);
					console.log("------------->data.resultMsg = " + data.resultMsg);
					console.log("------------->data.appToken = " + data.appToken);
					console.log("------------->data.subUserList = " + data.subUserList);
					//判断本地存储的appToken是否和服务器的appToken相同
					checkAppToken(data.appToken);
					if(data.resultCode == '1001'){
						//plus.ui.toast("查询矿机列表成功");
						//把appToken保存到本地
						//plus.storage.setItem('appToken',data.appToken);
						//查询成功，把列表显示到页面
						var html = "<ul class='mui-table-view' id='ul_machine'>";
						for(var i in data.subUserList){
							html += "<li class='mui-table-view-cell mui-media'>";
							html += "<a href='javascript:;>";
							html += "<img class='mui-media-object mui-pull-left src='http://dcloudio.github.io/mui/assets/img/yuantiao.jpg'>";
							html += "<div class='mui-media-body'>";
							html += "<p class='mui-ellipsis'>ID："+data.subUserList[i].userNo+"&nbsp;&nbsp;|&nbsp;&nbsp;算力："+data.subUserList[i].calculate+"&nbsp;&nbsp;|&nbsp;&nbsp;矿机："+data.subUserList[i].amount+"台</p>";
							html += "<p class='mui-ellipsis'>"+data.subUserList[i].levelStr+"&nbsp;&nbsp;|&nbsp;&nbsp;直推："+data.subUserList[i].subUserCount+"人&nbsp;&nbsp;|&nbsp;&nbsp;团队："+data.subUserList[i].teamCount+"人</p>";
							html += "</div>";
							html += "</a>";
							html += "</li>";
						}
						html += "</ul>";
						document.getElementById("item1").innerHTML = html;
						//统计下线总矿池算力
						var subTotalCalculates = data.subTotalCalculates;
						document.getElementById("subTotalCalculates").innerText = subTotalCalculates;
						var totalOperationDays = data.totalOperationDays;
						document.getElementById("totalOperationDays").innerText = totalOperationDays;
					}else if(data.resultCode = '5008'){
						mui.toast(data.resultMsg);
					}
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					mui.toast("系统异常！");
					console.log("异常: " + type);
				}
			});
      	}
    </script>
</body>
</html>