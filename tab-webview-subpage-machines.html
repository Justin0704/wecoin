<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>矿机列表</title>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <style>
		html,body {
			background-color: #efeff4;
		}
		.title{
			margin: 20px 15px 10px;
			color: #6d6d72;
			font-size: 15px;
		}
		/*body {
		    background: url(img/background6.jpg) no-repeat fixed center center/100% 100%;
		}
		.mui-content {
		    overflow-x: hidden;
		    opacity:0.8;border-radius:15px 15px 15px 15px;
		}
		.mui-content {
		    height: auto;
		}
		.mui-bar,.mui-content{background-color: transparent;margin: 0px;}*/
		.mui-bar{background-color: #108EE9;height: 65px;}
		.mui-title{color: #FFFFFF;line-height: 75px;}
		.mui-scroll-wrapper {
			top: 15px;
		}
	</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<h1 id="title" class="mui-title">机市</h1>
	</header>
	<!--<div class="mui-content" style="padding-top: 65px;">
		<div id="machine" style="margin-bottom: 15px;">
		</div>
	</div>-->
	<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
		<div class="mui-scroll">
			<!--数据列表-->
			<ul class="mui-table-view mui-table-view-chevron">
				<div id="machine" style="margin-bottom: 15px;">
				</div>
			</ul>
		</div>
	</div>
	<script src="js/mui.min.js"></script>
    <script src="js/mui.lazyload.js"></script>
	<script src="js/mui.lazyload.img.js"></script>
    <script type="text/javascript" src="js/header.js" ></script>
    <script type="text/javascript" src="js/appToken.js" ></script>
	<script type="text/javascript" charset="utf-8">
      	mui.init({
      		pullRefresh: {
				container: '#pullrefresh',
				down: {
					height:50,//可选,默认50.触发下拉刷新拖动距离,
			        auto: false,//可选,默认false.首次加载自动下拉刷新一次
			        contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
			        contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
			        contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					callback: pulldownRefresh
				}/*,
				up: {
					contentrefresh: '正在加载...',
					callback: pullupRefresh
				}*/
			}
      	});
      	mui.plusReady(function(){
      		//mui.toast("加载机市页面");
      		document.body.removeAttribute('data-imagelazyload');
      		showMachines();
      	});
      	/**
		 * 下拉刷新具体业务实现
		 */
		function pulldownRefresh() {
			setTimeout(function() {
				
				showMachines();
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
			}, 500);
		}
      	function showMachines(){
      		mui.ajax(url + '/machines',{
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				headers:{'Content-Type':'application/json'},
				crossDomain:true,
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					console.log("------------->data = " + data);
					console.log("------------->data.resultCode = " + data.resultCode);
					console.log("------------->data.resultMsg = " + data.resultMsg);
					console.log("------------->data.appToken = " + data.appToken);
					console.log("------------->data.machines = " + data.machines);
					//判断本地存储的appToken是否和服务器的appToken相同
					checkAppToken(data.appToken);
					if(data.resultCode == '1001'){
						//plus.ui.toast("查询矿机列表成功");
						//把appToken保存到本地
						//plus.storage.setItem('appToken',data.appToken);
						//查询成功，把列表显示到页面
						var html = "<ul class='mui-table-view' id='ul_machine'>";
						for(var i in data.machines){
							html += "<li class='mui-table-view-cell mui-media'>";
							html += "<a href='javascript:;>";
							html += "<img class='mui-media-object mui-pull-right' id='hellworld_"+i+"' src='img/fuwuqi.jpg?version=" + Math.random() * 1000 + "'/>";
							html += "<div class='mui-media-body'>";
							html += data.machines[i].name;
							html += "<p class='mui-ellipsis'>算力："+data.machines[i].calculate+"</p>";
							html += "<p class='mui-ellipsis'>运行周期："+data.machines[i].operationCycle+"</p>";
							html += "<p class='mui-ellipsis'>收益总量："+data.machines[i].totalRevenue+"</p>";
							html += "</div>";
							html += "</a>";
							html += "<p align='center'><button class='mui-btn mui-btn-outlined mui-btn-yellow mui-icon mui-icon-plus-filled' style='width: 150px;' id='purchase' onclick='purchase("+data.machines[i].id+","+data.machines[i].purchaseWbt+")'>购买("+data.machines[i].purchaseWbt+"WBT)</button></p>";
							html += "</li>";
							html += "<li class='mui-table-view-divider'></li>";
						}
						html += "</ul>";
						document.getElementById("machine").innerHTML = html;
					}else if(data.resultCode = '5001'){
						mui.toast(data.resultMsg);
					}
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					mui.toast("系统异常！");
					console.log("异常: " + type);
				}
			});
      	}
      	function purchase(id,val){
      		//购买去机器的ID和价格
      		//mui.toast(id + " = " +val);
      		var btn = ['是', '否'];
      		mui.confirm('您确定要购买此矿机吗?', '温馨提示', btn, function(e) {
      			if(e.index == 0){
      				plus.nativeUI.showWaiting('正在购买...');
      				mui.ajax(url + '/purchaseMachine',{
		      			data:{
								"id": id,
		      					"purchaseWbt": val
							},
						dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型
						headers:{'Content-Type':'application/json'},
						crossDomain:true,
						success:function(data){
							//服务器返回响应，根据响应结果，分析是否登录成功；
							console.log("------------->data = " + data);
							console.log("------------->data.resultCode = " + data.resultCode);
							console.log("------------->data.resultMsg = " + data.resultMsg);
							console.log("------------->data.appToken = " + data.appToken);
							//判断本地存储的appToken是否和服务器的appToken相同
							checkAppToken(data.appToken);
							
							if(data.resultCode == '5005'){
								plus.nativeUI.closeWaiting();
								plus.ui.toast(data.resultMsg);
								//把appToken保存到本地
								//plus.storage.setItem('appToken',data.appToken);
								//查询成功，把列表显示到页面
							}else if(data.resultCode = '5002'){
								plus.nativeUI.closeWaiting();
								mui.toast(data.resultMsg);
							}else if(data.resultCode = '1002'){
								plus.nativeUI.closeWaiting();
								mui.toast(data.resultMsg);
							}
						},
						error:function(xhr,type,errorThrown){
							plus.nativeUI.closeWaiting();
							//异常处理；
							mui.toast("系统异常！");
							console.log("异常: " + type);
						}
					});
      			}
			});
      		
      	}
    </script>
</body>
</html>